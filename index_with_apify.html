<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meeting Transcriber & AI Notes</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #667eea, #764ba2);
    padding: 20px;
}
.container {
    max-width: 900px;
    margin: auto;
    background: #fff;
    border-radius: 12px;
    padding: 20px;
}
h1 {
    text-align: center;
}
.api-config input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
}
.controls button {
    padding: 12px;
    margin: 5px;
    font-size: 16px;
}
.transcript-box, .notes-box {
    border: 1px solid #ccc;
    padding: 10px;
    min-height: 120px;
    margin-top: 10px;
    white-space: pre-wrap;
}
.status {
    margin: 10px 0;
    font-weight: bold;
}
</style>
</head>

<body>
<div class="container">
    <h1>üé§ Meeting Transcriber & AI Notes</h1>

    <div class="api-config">
        <label><strong>Apify API Token</strong></label>
        <input type="password" id="apifyToken" placeholder="Paste Apify API Token here">
    </div>

    <div class="controls">
        <button id="recordBtn">Start Recording</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="generateBtn" disabled>Generate AI Notes</button>
    </div>

    <div class="status" id="status"></div>

    <h3>Transcript</h3>
    <div id="transcript" class="transcript-box"></div>

    <h3>Summary</h3>
    <div id="notes" class="notes-box"></div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let transcript = "";

const recordBtn = document.getElementById("recordBtn");
const stopBtn = document.getElementById("stopBtn");
const generateBtn = document.getElementById("generateBtn");
const transcriptDiv = document.getElementById("transcript");
const notesDiv = document.getElementById("notes");
const statusDiv = document.getElementById("status");
const apifyTokenInput = document.getElementById("apifyToken");

/* Save token */
if (localStorage.getItem("apifyToken")) {
    apifyTokenInput.value = localStorage.getItem("apifyToken");
}
apifyTokenInput.addEventListener("change", () => {
    localStorage.setItem("apifyToken", apifyTokenInput.value);
});

/* Upload audio to Apify */
async function uploadAudio(apiToken, blob) {
    const res = await fetch(
        `https://api.apify.com/v2/key-value-stores/default/records/meeting-audio.webm?token=${apiToken}`,
        { method: "PUT", body: blob }
    );
    if (!res.ok) throw new Error("Audio upload failed");
    return "https://api.apify.com/v2/key-value-stores/default/records/meeting-audio.webm";
}

/* Start recording */
recordBtn.onclick = async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    transcript = "";
    transcriptDiv.textContent = "";
    notesDiv.textContent = "";

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();

    recordBtn.disabled = true;
    stopBtn.disabled = false;
    statusDiv.textContent = "Recording...";
};

/* Stop recording */
stopBtn.onclick = () => {
    mediaRecorder.stop();
    recordBtn.disabled = false;
    stopBtn.disabled = true;
    generateBtn.disabled = false;
    statusDiv.textContent = "Recording stopped.";
};

/* Generate AI notes */
generateBtn.onclick = async () => {
    try {
        const token = apifyTokenInput.value.trim();
        if (!token) return alert("Paste Apify API token first");

        statusDiv.textContent = "Uploading audio...";
        const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
        const audioUrl = await uploadAudio(token, audioBlob);

        statusDiv.textContent = "Transcribing & summarizing...";
        const res = await fetch(
            `https://api.apify.com/v2/acts/philip.boyedoku~audio-summariser-apify-deployment/run-sync-get-dataset-items?token=${token}`,
            {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    audio_url: audioUrl,
                    task: "transcribe_and_summarize"
                })
            }
        );

        const data = await res.json();
        transcriptDiv.textContent = data[0].transcript || "";
        notesDiv.textContent = data[0].summary || "";

        statusDiv.textContent = "Done ‚úÖ";
    } catch (err) {
        console.error(err);
        statusDiv.textContent = "Error ‚ùå Check console";
    }
};
</script>
</body>
</html>
